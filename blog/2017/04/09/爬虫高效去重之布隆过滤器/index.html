<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>爬虫高效去重之布隆过滤器 - 陌上人如玉,公子世无双</title>
  <meta charset="utf-8" />
  <meta name="author" content="Samray" />
  <meta name="description" content="an dscription about bloom filter" />
  <meta name="keywords" content="python,bloom-filter,crawler" />

  <link rel="alternate" title="RSS Feed" href="/rss.xml" type="application/rss+xml">
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/posts.css" type="text/css">
</head>

  <body class="container">
<header id="header">
<body>
    <nav class="navbar navbar-default navbar-fixed-top" style="opacity: .9" role="navigation">
        <div class="container-fluid">
<div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">陌上人如玉,公子世无双</a>
        </div>
<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a href="/">Blog</a></li>
          <li><a href="https://github.com/samrayleung">GitHub</a></li>
        </ul>
</div>
</div>
    </nav>
</body>
</header>

<section id="content" role="main">
    <div id="outline-container-sec-" class="row" style="padding-top: 70px">
        <div class="col-md-2"></div>
            <h1>爬虫高效去重之布隆过滤器</h1>
            <p>
笔者最近思考如何编写高效的爬虫; 而在编写高效爬虫的时候，有一个必需解决的问题就是：
url 的去重，即如何判别 url 是否已经被爬取，如果被爬取，那就不要重复爬取。一般如
果需要爬取的网站不是非常庞大的话，使用Python 内置的 set 就可以实现去重了，但是使
用 set 内存利用率不高，此外对于那些不像Python 那样用 hash 实现的 set 而言，时间
复杂度是 log(N),实在难说高效。
</p>
<div id="outline-container-orgc48a1de" class="outline-2">
<h2 id="orgc48a1de">Bloom Filter</h2>
<div class="outline-text-2" id="text-orgc48a1de">
<p>
那么如何实现高效的去重呢？ 笔者查阅资料之后得知：使用布隆过滤器 (Bloom
Filter). 布隆过滤器可以用于快速检索一个元素是否在一个集合中。布隆过滤器实际上
是一个很长的二进制向量和一系列随机映射函数（Hash函数）。而一般的判断一个元素是
否在一个集合里面的做法是：用需要判断的元素和集合中的元素进行比较，一般的数据结
构，例如链表，树，都是这么实现的。缺点是：随着集合元素的增多，需要比较的元素也
增多，检索速度就越来越慢。而使用布隆过滤器判重可以实现常数级的时间复杂度(检索
时间不随元素增长而增加).那么布隆过滤器又是怎样实现的呢
</p>
</div>
<div id="outline-container-orgc87cedd" class="outline-3">
<h3 id="orgc87cedd">布隆过滤器实现原理</h3>
<div class="outline-text-3" id="text-orgc87cedd">
<p>
一个Bloom Filter是基于一个m位的位向量（Bit Vector），这些位向量的初始值为0,并
且有一系列的 hash 函数，hash 函数值域为1-m.在下面例子中，是15位的位向量，初始
值为0以空白表示，为1以颜色填充
</p>


<div class="figure">
<p><img src="/assets/blog/2017/04/09/爬虫高效去重之布隆过滤器/bit_vector.png" alt="bit_vector.png" />
</p>
</div>

<p>
现在有两个简单的 hash 函数：fnv,murmur.现在我输入一个字符串 "whatever" ,然后
分别使用两个 hash 函数对 "whatever" 进行散列计算并且映射到上面的位向量。
</p>


<div class="figure">
<p><img src="/assets/blog/2017/04/09/爬虫高效去重之布隆过滤器/whatever.png" alt="whatever.png" />
</p>
</div>

<p>
可知，使用 fnv 函数计算出的 hash 值是11,使用 murmur 函数计算出的 hash 值
是4. 然后映射到位向量上：
</p>


<div class="figure">
<p><img src="/assets/blog/2017/04/09/爬虫高效去重之布隆过滤器/bit_vector1.png" alt="bit_vector1.png" />
</p>
</div>

<p>
如果下一次，笔者要判断 <b>whatever</b> 是否在字符串中，只需使用 fnv 和 murmur 两个
hash 函数对 <b>whatever</b> 进行散列值计算，然后与位向量做 "与运算"，如果结果为0,
那么说明 <b>whatever</b> 是不在集合中的，因为同样的元素使用同一个 hash 函数产生的
值每次都是相同的，不相同就说明不是同一个元素。但是如果 "与运算" 的结果为1,是
否可以说明 <b>whatever</b> 就在集合中呢？其实上是不能100% 确定的，因为 hash 函数存
在散列冲突现象 (即两个散列值相同，但两个输入值是不同的),所以布隆过滤器只能说"
我可以说这个元素我在集合中是看见过滴，只是我有一定的不确定性".当你在分配的内
存足够大之后，不确定性会变得很小很小。你可以看到布隆过滤器可以有效利用内存实
现常数级的判重任务，但是鱼和熊掌不可得兼，付出的代价就是一定的误判 (机率很小),所
以本质上，布隆过滤器是 "概率数据结构 (probabilistic data structure)".这个就是
布隆过滤器的基本原理。当然，位向量不会只是15位，hash 函数也不会仅是两个简单的
函数.这只是简化枝节，为了清晰解述原理而已。
</p>
</div>
</div>
</div>
<div id="outline-container-org156a8ed" class="outline-2">
<h2 id="org156a8ed">Python BloomFilter</h2>
<div class="outline-text-2" id="text-org156a8ed">
<p>
算法都是为了实际问题服务的，又回到爬虫这个话题上。在了解布隆过滤器原理之后，可
以很容易地实现自己的布隆过滤器，但是想要实现一个高效健壮的布隆过滤器就需要比较
多的功夫了，因为需要考虑的问题略多。幸好，得益Python 强大的社区，已经有<a href="https://axiak.github.io/pybloomfiltermmap/">Python
BloomFilter</a> 的库。一个文档中的简单例子：
</p>

<div class="org-src-container">
<pre class="src src-python">from pybloomfilter import BloomFilter

bf = BloomFilter(10000000, 0.01, 'filter.bloom')

with open("/usr/share/dict/words") as f:
    for word in f:
	bf.add(word.rstrip())

print 'apple' in bf
</pre>
</div>
<p>
结果为 <b>True</b>
</p>
</div>
</div>
<div id="outline-container-orgb6227dd" class="outline-2">
<h2 id="orgb6227dd">结果</h2>
<div class="outline-text-2" id="text-orgb6227dd">
<p>
原理就说得差不多了，要想对布隆过滤器有更深的认识，还需要更多的实战。多写，多思
考。 Enjoy Python,Enjoy Crawler :)
</p>
</div>
</div>
<div id="outline-container-orga0870d5" class="outline-2">
<h2 id="orga0870d5">参考</h2>
<div class="outline-text-2" id="text-orga0870d5">
<ul class="org-ul">
<li><a href="https://llimllib.github.io/bloomfilter-tutorial/">https://llimllib.github.io/bloomfilter-tutorial/</a></li>
<li><a href="https://en.wikipedia.org/wiki/Bloom_filter">https://en.wikipedia.org/wiki/Bloom_filter</a></li>
</ul>
</div>
</div>

    </div>
</section>


<footer id="footer">
    <br />
</footer>

  </body>
</html>
